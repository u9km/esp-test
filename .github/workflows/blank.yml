name: Build ESP Master

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Theos & SDK
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          curl -L https://github.com/theos/sdks/archive/master.zip -o sdks.zip
          unzip -q sdks.zip
          mv sdks-master/*.sdk ~/theos/sdks/
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      - name: âš™ï¸ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ Ù„Ù„Ù…Ù„ÙØ§Øª
        run: |
          mkdir -p ESP SDK
          unzip -o mini.zip || true
          
          # Ù†Ù‚Ù„ Ù…Ù„ÙØ§Øª ESP Ø¨Ø°ÙƒØ§Ø¡ ÙˆØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØµÙŠÙ†ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
          find . -path "*/ESP/*" -type f \( -name "*.mm" -o -name "*.m" -o -name "*.cpp" -o -name "*.h" -o -name "*.hpp" \) -not -name "*[!-a-zA-Z0-9._/]*" -exec cp {} ESP/ \; 2>/dev/null || true
          
          # Ù†Ù‚Ù„ Ù…Ù„ÙØ§Øª SDK 4.2 Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
          find . -path "*/SDK/*" -type f -exec cp {} SDK/ \; 2>/dev/null || true
          
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ JRMemory.framework ÙÙŠ Ù…ÙƒØ§Ù†Ù‡
          find . -name "JRMemory.framework" -type d -exec cp -R {} ESP/ \; 2>/dev/null || true

      - name: ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ù†Ø§Ø¡
        run: |
          export THEOS=$HOME/theos
          chmod -R +x $THEOS/bin
          make package FINALPACKAGE=1 THEOS_PACKAGE_SCHEME=rootless
          
      - name: ğŸ“¦ Ø§Ù„Ø±ÙØ¹
        uses: actions/upload-artifact@v4
        with:
          name: ESP_Dylib_Ready
          path: packages/*.deb
