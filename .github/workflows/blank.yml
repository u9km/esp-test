name: Build ESP Master Fix

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Theos & SDK
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          curl -L https://github.com/theos/sdks/archive/master.zip -o sdks.zip
          unzip -q sdks.zip
          mv sdks-master/*.sdk ~/theos/sdks/
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      - name: âš™ï¸ ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙˆÙÙƒ Ø§Ù„Ø¶ØºØ·
        run: |
          mkdir -p ESP SDK
          unzip -o mini.zip || true
          
          # Ù†Ù‚Ù„ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
          cp -R mini/mini/ESP/* ESP/ 2>/dev/null || cp -R mini/ESP/* ESP/ || true
          cp -R mini/mini/SDK/* SDK/ 2>/dev/null || cp -R mini/SDK/* SDK/ || true
          
          # Ù†Ù‚Ù„ Ù…Ù„Ù metalbiew.mm Ùˆ metalbiew.h Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Ø§ Ø¨Ø§Ù„Ø¯Ø§Ø®Ù„
          find . -name "metalbiew.mm" -exec cp {} . \;
          find . -name "metalbiew.h" -exec cp {} ESP/ \;
          
          # Ù†Ù‚Ù„ Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ†
          find . -name "control" -exec cp {} . \;
          find . -name "App.plist" -exec cp {} . \;

      - name: ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ù†Ø§Ø¡
        run: |
          export THEOS=$HOME/theos
          chmod -R +x $THEOS/bin
          make package FINALPACKAGE=1 THEOS_PACKAGE_SCHEME=rootless
          
      - name: ğŸ“¦ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ø§ØªØ¬
        uses: actions/upload-artifact@v4
        with:
          name: ESP_Fixed_Dylib
          path: packages/*.deb
