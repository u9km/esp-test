name: Build ESP Pro Fixed

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Theos & iOS SDK
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          curl -L https://github.com/theos/sdks/archive/master.zip -o sdks.zip
          unzip -q sdks.zip
          mv sdks-master/*.sdk ~/theos/sdks/
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      - name: โ๏ธ ุงุณุชุฎุฑุงุฌ ูุชูุธูู ูููุงุชู ุงููุฏููุฉ
        run: |
          mkdir -p ESP SDK
          # ูู ุงูุถุบุท ูุชุฌุงูู ุฃุฎุทุงุก ุงูุฑููุฒ ุงูุตูููุฉ (ุญู Exit Code 50)
          unzip -o mini.zip || true
          
          # ููู ูููุงุช ESP ูุงูู SDK 4.2 ุงูุฎุงุตุฉ ุจู ูููุงููุง ุงูุตุญูุญ
          find . -path "*/ESP/*" -type f -exec cp {} ESP/ \; 2>/dev/null || true
          find . -path "*/SDK/*" -type f -exec cp {} SDK/ \; 2>/dev/null || true
          cp metalbiew.mm . 2>/dev/null || find . -name "metalbiew.mm" -exec cp {} . \;
          
          # ุฌูุจ ูููุงุช ุงูุฅุนุฏุงุฏ
          find . -name "control" -exec cp {} . \; 2>/dev/null || true
          find . -name "App.plist" -exec cp {} . \; 2>/dev/null || true

      - name: ๐ ุจุฏุก ุงูุจูุงุก (Build)
        run: |
          export THEOS=$HOME/theos
          chmod -R +x $THEOS/bin
          # ุงุณุชุฎุฏุงู ุงููุฌูุฏ ุงูุญุงูู ููุจูุงุก ูุถูุงู ุงูุนุซูุฑ ุนูู tweak.mk
          make package FINALPACKAGE=1 THEOS_PACKAGE_SCHEME=rootless

      - name: ๐ฆ ุชุญููู ุงูููู ุงููุงุชุฌ
        uses: actions/upload-artifact@v4
        with:
          name: ESP_Dylib_Ready
          path: packages/*.deb
